{% extends "base.html" %}

{% block title %}å®ç”¨å·¥å…·{% endblock %}

{% block content %}
    <h1>å®ç”¨å°å·¥å…· ğŸ› ï¸</h1>
    <p>è¿™é‡Œæä¾›ä¸€äº›æˆ‘æ—¥å¸¸éœ€è¦ç”¨åˆ°çš„å°å·¥å…·ã€‚</p>

    <div class="card tool-card">
        <h2>1. å›¾ç‰‡å¤§å°è°ƒæ•´ (KB)</h2>
        <p>ä¸Šä¼ å›¾ç‰‡ (ä»…æ”¯æŒ JPEG/PNG)ï¼ŒæŒ‡å®šç›®æ ‡æ–‡ä»¶å¤§å° (KB)ï¼Œå·¥å…·ä¼šå°è¯•é€šè¿‡è°ƒæ•´ JPEG è´¨é‡æ¥å‹ç¼©å›¾ç‰‡åˆ°æ¥è¿‘çš„å¤§å° (PNG å‹ç¼©æ•ˆæœæœ‰é™)ã€‚</p>
        <form id="resize-form"> {/* Removed enctype, JS will handle it */}
            <div>
                <label for="resize-image">é€‰æ‹©å›¾ç‰‡:</label>
                <input type="file" id="resize-image" name="image" accept="image/jpeg, image/png" required>
            </div>
            <div>
                <label for="target-size">ç›®æ ‡å¤§å° (KB):</label>
                <input type="number" id="target-size" name="target_size_kb" min="1" required step="1">
            </div>
            <button type="submit" class="btn">å¼€å§‹è°ƒæ•´</button>
        </form>
        <div id="resize-loading" class="tool-loading" style="display: none;">
            <div class="spinner"></div> å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
        </div>
        <div id="resize-result" class="tool-result"></div>
    </div>

    <div class="card tool-card">
        <h2>2. è¯ä»¶ç…§èƒŒæ™¯æ›´æ¢</h2>
        <p>ä¸Šä¼ è¯ä»¶ç…§ (ä»…æ”¯æŒ JPEG/PNG)ï¼Œé€‰æ‹©æˆ–è¾“å…¥å½“å‰èƒŒæ™¯è‰²å’Œç›®æ ‡èƒŒæ™¯è‰²ã€‚æ•ˆæœå–å†³äºèƒŒæ™¯çš„çº¯å‡€åº¦ã€‚</p>
        <form id="bg-change-form"> {/* Removed enctype */}
            <div>
                <label for="bg-image">é€‰æ‹©è¯ä»¶ç…§:</label>
                <input type="file" id="bg-image" name="image" accept="image/jpeg, image/png" required>
            </div>
            <div class="color-picker-container">
                <label for="original-color">åŸèƒŒæ™¯è‰²:</label>
                <input type="color" id="original-color" name="original_color" value="#0000ff">
                <select onchange="document.getElementById('original-color').value = this.value; this.style.backgroundColor = this.value;">
                    <option value="#0000ff" style="background-color: #0000ff;">è“è‰²</option>
                    <option value="#ffffff" style="background-color: #ffffff;">ç™½è‰²</option>
                    <option value="#ff0000" style="background-color: #ff0000;">çº¢è‰²</option>
                    <option value="#cccccc" style="background-color: #cccccc;">ç°è‰²</option>
                </select>
            </div>
             <div class="color-picker-container">
                <label for="target-color">æ–°èƒŒæ™¯è‰²:</label>
                <input type="color" id="target-color" name="target_color" value="#ffffff">
                 <select onchange="document.getElementById('target-color').value = this.value; this.style.backgroundColor = this.value;">
                    <option value="#ffffff" style="background-color: #ffffff;">ç™½è‰²</option>
                    <option value="#0000ff" style="background-color: #0000ff;">è“è‰²</option>
                    <option value="#ff0000" style="background-color: #ff0000;">çº¢è‰²</option>
                    <option value="#cccccc" style="background-color: #cccccc;">ç°è‰²</option>
                </select>
            </div>
            <div>
                <label for="tolerance">é¢œè‰²å®¹å·® (0-100):</label>
                <input type="number" id="tolerance" name="tolerance" min="0" max="100" value="30" step="1">
                 <small>æ•°å€¼è¶Šå¤§ï¼Œæ›¿æ¢èŒƒå›´è¶Šå¹¿ï¼Œä½†ä¹Ÿå¯èƒ½è¯¯ä¼¤ä¸»ä½“ã€‚</small>
            </div>
            <button type="submit" class="btn">æ›´æ¢èƒŒæ™¯</button>
        </form>
        <div id="bg-change-loading" class="tool-loading" style="display: none;">
             <div class="spinner"></div> å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
        </div>
        <div id="bg-change-result" class="tool-result"></div>
    </div>

    <div class="card tool-card">
        <h2>3. IP åœ°å€æŸ¥è¯¢</h2>
        <p>æ˜¾ç¤ºä½ å½“å‰çš„å…¬ç½‘ IP åœ°å€ (å¯èƒ½å—ä»£ç†å½±å“)ã€‚</p>
        <button id="get-ip-btn" class="btn">æŸ¥è¯¢æˆ‘çš„ IP</button>
         <div id="ip-loading" class="tool-loading" style="display: none;">
             <div class="spinner"></div> æŸ¥è¯¢ä¸­...
        </div>
        <div id="ip-result" class="tool-result"></div>
    </div>

    <style>
        .tool-card { margin-bottom: 2rem; }
        .tool-card h2 { margin-bottom: 0.5rem; }
        .tool-card p { text-align: left; max-width: none; margin-bottom: 1.5rem; }
        .tool-card form div { margin-bottom: 1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem 1rem;}
        .tool-card label { display: inline-block; min-width: 120px; font-weight: 500; margin-bottom: 0; /* Adjusted */}
        .tool-card input[type="file"],
        .tool-card input[type="number"],
        .tool-card input[type="color"],
        .tool-card select {
            padding: 0.6rem 0.8rem; /* Increased padding */
            border: 1px solid var(--border-color);
            border-radius: 6px; /* Slightly more rounded */
            background-color: var(--bg-secondary); /* Lighter background */
            color: var(--text-dark);
            font-size: 0.95rem; /* Slightly larger font */
            flex-grow: 1; /* Allow input to grow */
            max-width: 300px; /* Limit max width */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .tool-card input[type="color"] {
            padding: 0.2rem; /* Reduced padding for color input */
            height: 40px; /* Fixed height */
            min-width: 50px;
            max-width: 60px; /* Fixed width */
            flex-grow: 0;
        }
        .tool-card select {
             cursor: pointer;
             max-width: 150px; /* Limit select width */
             flex-grow: 0;
        }
        .tool-card input:focus, .tool-card select:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); /* Subtle focus ring */
        }
        .tool-card small { color: var(--text-light); font-size: 0.85rem; width: 100%; margin-left: 130px; /* Align with inputs */}

        .color-picker-container { display: flex; align-items: center; gap: 0.5rem; }
        .color-picker-container label { margin-bottom: 0; } /* Remove bottom margin for labels in this container */

        .tool-result { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .tool-result img {
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px; /* Added border-radius */
            display: block; /* Ensure img is block for centering */
            margin-left: auto;
            margin-right: auto; /* Center image */
        }
        .tool-result a.btn { display: inline-block; margin-top: 1rem; }
        .tool-result p { margin-top: 1rem; font-weight: bold; text-align: center; } /* Center result text */
        .tool-result .info { font-weight: normal; color: var(--text-light); font-size: 0.9rem; } /* Style for file size info */

         /* Loading indicator style */
        .tool-loading {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-style: italic;
        }
        /* Reusing spinner animation from base styles */
        .tool-loading .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        /* Keyframes for spin are assumed to be in style.css */

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .tool-card form div { flex-direction: column; align-items: flex-start; }
            .tool-card label { min-width: auto; margin-bottom: 0.5rem; }
             .tool-card input[type="file"],
            .tool-card input[type="number"],
            .tool-card select,
            .tool-card input[type="color"] { max-width: 100%; } /* Full width on small screens */
            .tool-card small { margin-left: 0; }
            .color-picker-container { flex-direction: row; align-items: center; width: 100%;} /* Keep color picker row layout */
            .color-picker-container label { margin-bottom: 0;}
        }

    </style>

    <script>
        // Helper function to display errors
        function displayError(element, message) {
            element.innerHTML = `<p style="color: #dc2626; text-align: center;">âŒ é”™è¯¯: ${message}</p>`;
        }

        // Helper function to display success messages or results
        function displayResult(element, htmlContent) {
            element.innerHTML = htmlContent;
        }

        // --- å›¾ç‰‡å¤§å°è°ƒæ•´é€»è¾‘ ---
        const resizeForm = document.getElementById('resize-form');
        const resizeResult = document.getElementById('resize-result');
        const resizeLoading = document.getElementById('resize-loading');
        const resizeImageInput = document.getElementById('resize-image');
        const resizeTargetInput = document.getElementById('target-size');

        resizeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!resizeImageInput.files || resizeImageInput.files.length === 0) {
                displayError(resizeResult, "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚");
                return;
            }
            if (!resizeTargetInput.value || parseInt(resizeTargetInput.value) <= 0) {
                 displayError(resizeResult, "è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®æ ‡å¤§å° (KB)ã€‚");
                return;
            }


            resizeLoading.style.display = 'flex'; // Show loading indicator
            resizeResult.innerHTML = ''; // Clear previous result

            const formData = new FormData();
            formData.append('image', resizeImageInput.files[0]);
            const targetSizeKb = resizeTargetInput.value;
            const url = `/tools/resize-image?target_size_kb=${encodeURIComponent(targetSizeKb)}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status}: ${errorText || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                const originalFileName = resizeImageInput.files[0].name;
                // Basic extension extraction, might need improvement for complex names
                const extension = originalFileName.includes('.') ? originalFileName.split('.').pop() : 'jpg';
                 // Determine output extension based on mime type if possible
                let outputExtension = 'jpg'; // Default to jpg
                if (blob.type === 'image/png') {
                    outputExtension = 'png';
                } else if (blob.type === 'image/jpeg') {
                    outputExtension = 'jpg';
                }


                const baseFileName = originalFileName.includes('.') ? originalFileName.substring(0, originalFileName.lastIndexOf('.')) : originalFileName;
                const newFileName = `${baseFileName}_resized_${targetSizeKb}kb.${outputExtension}`;
                const fileSizeKB = (blob.size / 1024).toFixed(2);

                const resultHtml = `
                    <p>âœ… è°ƒæ•´æˆåŠŸ (ç›®æ ‡ ${targetSizeKb} KB):</p>
                    <img src="${imageUrl}" alt="è°ƒæ•´åçš„å›¾ç‰‡">
                    <p class="info">å®é™…æ–‡ä»¶å¤§å°: ${fileSizeKB} KB</p>
                    <a href="${imageUrl}" download="${newFileName}" class="btn btn-secondary">ä¸‹è½½å›¾ç‰‡</a>
                `;
                displayResult(resizeResult, resultHtml);

            } catch (error) {
                 console.error("å›¾ç‰‡è°ƒæ•´å‡ºé”™:", error);
                 displayError(resizeResult, error.message || "è°ƒæ•´è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚");
            } finally {
                resizeLoading.style.display = 'none'; // Hide loading indicator
            }
        });

        // --- èƒŒæ™¯æ›´æ¢é€»è¾‘ ---
        const bgChangeForm = document.getElementById('bg-change-form');
        const bgChangeResult = document.getElementById('bg-change-result');
        const bgChangeLoading = document.getElementById('bg-change-loading');
        const bgImageInput = document.getElementById('bg-image');
        const originalColorInput = document.getElementById('original-color');
        const targetColorInput = document.getElementById('target-color');
        const toleranceInput = document.getElementById('tolerance');

        bgChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!bgImageInput.files || bgImageInput.files.length === 0) {
                displayError(bgChangeResult, "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯ä»¶ç…§æ–‡ä»¶ã€‚");
                return;
            }
             if (!toleranceInput.value || parseInt(toleranceInput.value) < 0 || parseInt(toleranceInput.value) > 100) {
                 displayError(bgChangeResult, "è¯·è¾“å…¥æœ‰æ•ˆçš„é¢œè‰²å®¹å·® (0-100)ã€‚");
                return;
            }


            bgChangeLoading.style.display = 'flex'; // Show loading
            bgChangeResult.innerHTML = ''; // Clear result

            const formData = new FormData();
            formData.append('image', bgImageInput.files[0]);

            const originalColor = originalColorInput.value;
            const targetColor = targetColorInput.value;
            const tolerance = toleranceInput.value;
            const url = `/tools/change-background?original_color=${encodeURIComponent(originalColor)}&target_color=${encodeURIComponent(targetColor)}&tolerance=${encodeURIComponent(tolerance)}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status}: ${errorText || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const result = await response.json();

                if (result.success && result.imageData) {
                     const originalFileName = bgImageInput.files[0].name;
                     // Extract base name and attempt to keep original extension if possible from data URL
                     const baseFileName = originalFileName.includes('.') ? originalFileName.substring(0, originalFileName.lastIndexOf('.')) : originalFileName;
                     let outputExtension = 'png'; // Default to png for background changes
                     const mimeMatch = result.imageData.match(/^data:(image\/(\w+));base64,/);
                     if(mimeMatch && mimeMatch[2]) {
                         outputExtension = mimeMatch[2] === 'jpeg' ? 'jpg' : mimeMatch[2];
                     }
                    const newFileName = `${baseFileName}_bg_changed.${outputExtension}`;

                    const resultHtml = `
                        <p>âœ… èƒŒæ™¯æ›´æ¢æˆåŠŸ:</p>
                        <img src="${result.imageData}" alt="èƒŒæ™¯æ›´æ¢åçš„å›¾ç‰‡">
                         <a href="${result.imageData}" download="${newFileName}" class="btn btn-secondary">ä¸‹è½½å›¾ç‰‡</a>
                    `;
                    displayResult(bgChangeResult, resultHtml);
                } else {
                    throw new Error(result.message || 'åç«¯å¤„ç†å¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆå›¾ç‰‡æ•°æ®ã€‚');
                }

            } catch (error) {
                 console.error("èƒŒæ™¯æ›´æ¢å‡ºé”™:", error);
                 displayError(bgChangeResult, error.message || 'èƒŒæ™¯æ›´æ¢è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚');
            } finally {
                bgChangeLoading.style.display = 'none'; // Hide loading
            }
        });

        // --- IP æŸ¥è¯¢é€»è¾‘ ---
        const getIpBtn = document.getElementById('get-ip-btn');
        const ipResult = document.getElementById('ip-result');
        const ipLoading = document.getElementById('ip-loading');

        getIpBtn.addEventListener('click', async () => {
            ipLoading.style.display = 'flex'; // Show loading
            ipResult.innerHTML = ''; // Clear result
            try {
                const response = await fetch('/api/tools/my-ip');
                if (!response.ok) {
                    throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText || ''}`);
                }
                const data = await response.json();
                 if (data.ip) {
                    displayResult(ipResult, `<p>ğŸŒ ä½ çš„ IP åœ°å€æ˜¯: <strong>${data.ip}</strong></p>`);
                 } else {
                     throw new Error("æœªèƒ½ä»æœåŠ¡å™¨è·å– IP åœ°å€ã€‚");
                 }

            } catch (error) {
                console.error("IP æŸ¥è¯¢å‡ºé”™:", error);
                displayError(ipResult, error.message || 'æŸ¥è¯¢ IP åœ°å€æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚');
            } finally {
                ipLoading.style.display = 'none'; // Hide loading
            }
        });

         // --- Style select based on color input change ---
         document.getElementById('original-color').addEventListener('input', (e) => {
             const select = e.target.nextElementSibling; // Get the sibling select element
             if (select && select.tagName === 'SELECT') {
                 select.style.backgroundColor = e.target.value;
                 // Optionally reset select value if custom color is chosen
                 // select.value = ''; // Or find a 'custom' option if you add one
             }
         });
         document.getElementById('target-color').addEventListener('input', (e) => {
             const select = e.target.nextElementSibling;
             if (select && select.tagName === 'SELECT') {
                 select.style.backgroundColor = e.target.value;
             }
         });
         // Initialize select backgrounds on load
         document.querySelectorAll('select[onchange*="backgroundColor"]').forEach(select => {
            select.style.backgroundColor = select.value;
         });


    </script>

{% endblock %}