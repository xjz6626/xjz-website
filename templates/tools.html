{% extends "base.html" %}

{% block title %}å®ç”¨å·¥å…·{% endblock %}

{% block content %}
    <h1>å®ç”¨å°å·¥å…· ğŸ› ï¸</h1>
    <p>è¿™é‡Œæä¾›ä¸€äº›æˆ‘æ—¥å¸¸éœ€è¦ç”¨åˆ°çš„å°å·¥å…·ã€‚</p>

    <div class="card tool-card">
        <h2>1. å›¾ç‰‡å¤§å°è°ƒæ•´ (KB)</h2>
        <p>ä¸Šä¼ å›¾ç‰‡ (JPEG/PNG)ï¼ŒæŒ‡å®šç›®æ ‡å¤§å° (KB) å’Œè¾“å‡ºæ ¼å¼ã€‚å·¥å…·ä¼šå°è¯•å‹ç¼© (JPEGè´¨é‡/PNGé‡åŒ–) æˆ–å¡«å……ä»¥è¾¾åˆ°ç›®æ ‡ã€‚</p>
        <form id="resize-form">
            <div>
                <label for="resize-image">é€‰æ‹©å›¾ç‰‡:</label>
                <input type="file" id="resize-image" name="image" accept="image/jpeg, image/png" required>
            </div>
            <div>
                <label for="target-size">ç›®æ ‡å¤§å° (KB):</label>
                <input type="number" id="target-size" name="target_size_kb" min="1" required step="1">
            </div>
            <div>
                <label for="output-format">è¾“å‡ºæ ¼å¼:</label>
                <select id="output-format" name="output_format">
                    <option value="auto" selected>è‡ªåŠ¨ (åŒè¾“å…¥)</option>
                    <option value="jpeg">JPEG</option>
                    <option value="png">PNG</option>
                </select>
            </div>
            <button type="submit" class="btn">å¼€å§‹è°ƒæ•´</button>
        </form>
        <div id="resize-loading" class="tool-loading" style="display: none;">
            <div class="spinner"></div> å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
        </div>
        <div id="resize-result" class="tool-result"></div>
    </div>

    <div class="card tool-card">
        <h2>2. è¯ä»¶ç…§èƒŒæ™¯æ›´æ¢</h2>
        <p>ä¸Šä¼ è¯ä»¶ç…§ (JPEG/PNG)ï¼Œé€‰æ‹©ç›®æ ‡èƒŒæ™¯è‰²ã€‚å·¥å…·å°†**è‡ªåŠ¨ç§»é™¤èƒŒæ™¯**å¹¶æ›¿æ¢ä¸ºæŒ‡å®šé¢œè‰²ï¼ˆæˆ–é€æ˜ï¼‰ã€‚</p>
        <form id="bg-change-form">
            <div>
                <label for="bg-image">é€‰æ‹©è¯ä»¶ç…§:</label>
                <input type="file" id="bg-image" name="image" accept="image/jpeg, image/png" required>
            </div>
             <div class="color-picker-container">
                <label for="target-color">æ–°èƒŒæ™¯è‰²:</label>
                <input type="color" id="target-color" name="target_color" value="#ffffff">
                 <select onchange="document.getElementById('target-color').value = this.value; this.style.backgroundColor = this.value;">
                    <option value="#ffffff" style="background-color: #ffffff;">ç™½è‰²</option>
                    <option value="#0000ff" style="background-color: #0000ff;">è“è‰²</option>
                    <option value="#ff0000" style="background-color: #ff0000;">çº¢è‰²</option>
                    <option value="#cccccc" style="background-color: #cccccc;">ç°è‰²</option>
                </select>
            </div>
            <button type="submit" class="btn">æ›´æ¢èƒŒæ™¯</button>
        </form>
        <div id="bg-change-loading" class="tool-loading" style="display: none;">
             <div class="spinner"></div> å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
        </div>
        <div id="bg-change-result" class="tool-result"></div>
    </div>

    <div class="card tool-card">
        <h2>3. IP åœ°å€æŸ¥è¯¢</h2>
        <p>æ˜¾ç¤ºä½ å½“å‰çš„å…¬ç½‘ IP åœ°å€ (å¯èƒ½å—ä»£ç†å½±å“)ã€‚</p>
        <button id="get-ip-btn" class="btn">æŸ¥è¯¢æˆ‘çš„ IP</button>
         <div id="ip-loading" class="tool-loading" style="display: none;">
             <div class="spinner"></div> æŸ¥è¯¢ä¸­...
        </div>
        <div id="ip-result" class="tool-result"></div>
    </div>

    <div class="card tool-card">
        <h2>4. ç¾å›½è™šæ‹Ÿèº«ä»½ç”Ÿæˆå™¨</h2>
        <p>ç”Ÿæˆç”¨äºç½‘ç«™æ³¨å†Œçš„ç¾å›½è™šæ‹Ÿä¸ªäººä¿¡æ¯ã€‚</p>
        <form id="fake-id-form">
            <button type="submit" class="btn">ç”Ÿæˆä¿¡æ¯</button>
        </form>
        <div id="fake-id-loading" class="tool-loading" style="display: none;">
            <div class="spinner"></div> ç”Ÿæˆä¸­...
        </div>
        <div id="fake-id-result" class="tool-result"></div>
    </div>


    <style>
        /* ... æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ ... */
        .tool-card { margin-bottom: 2rem; }
        .tool-card h2 { margin-bottom: 0.5rem; }
        .tool-card p { text-align: left; max-width: none; margin-bottom: 1.5rem; }
        .tool-card form div { margin-bottom: 1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem 1rem;}
        /* *** ä¿®æ”¹ç‚¹: ç¡®ä¿æ ‡ç­¾åœ¨æ²¡æœ‰ä¸‹æ‹‰èœå•æ—¶ä¹Ÿèƒ½å¯¹é½ *** */
        .tool-card form div:has(> button) { margin-bottom: 0; } /* å‡å°‘åªæœ‰æŒ‰é’®çš„è¡Œçš„åº•éƒ¨è¾¹è· */
        .tool-card label { display: inline-block; min-width: 120px; font-weight: 500; margin-bottom: 0; }
        .tool-card input[type="file"],
        .tool-card input[type="number"],
        .tool-card input[type="color"],
        .tool-card select {
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-dark);
            font-size: 0.95rem;
            flex-grow: 1;
            max-width: 300px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .tool-card input[type="color"] {
            padding: 0.2rem;
            height: 40px;
            min-width: 50px;
            max-width: 60px;
            flex-grow: 0;
        }
        .tool-card select {
             cursor: pointer;
             max-width: 150px; /* è°ƒæ•´æˆ–ç§»é™¤ */
             flex-grow: 0;
        }
        .tool-card input:focus, .tool-card select:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .tool-card small { color: var(--text-light); font-size: 0.85rem; width: 100%; margin-left: 130px; }

        .color-picker-container { display: flex; align-items: center; gap: 0.5rem; }
        .color-picker-container label { margin-bottom: 0; }

        .tool-result { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .tool-result img {
            max-width: 100%; height: auto; margin-top: 1rem; border: 1px solid var(--border-color);
            border-radius: 4px; display: block; margin-left: auto; margin-right: auto;
        }
        .tool-result a.btn { display: inline-block; margin-top: 1rem; }
        .tool-result p { margin-top: 1rem; font-weight: bold; text-align: center; }
        .tool-result .info { font-weight: normal; color: var(--text-light); font-size: 0.9rem; }

        .tool-loading {
            margin-top: 1.5rem; display: flex; align-items: center; justify-content: center;
            gap: 0.5rem; color: var(--text-light); font-style: italic;
        }
        .tool-loading .spinner {
            width: 20px; height: 20px; border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* è™šæ‹Ÿèº«ä»½ç»“æœæ ·å¼ */
        .fake-id-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 0.8rem 1rem;
            text-align: left;
            font-size: 0.95rem;
            word-break: break-all;
        }
        .fake-id-grid strong {
            font-weight: 500;
            color: var(--text-light);
            text-align: right;
        }
        .fake-id-grid span {
            color: var(--text-dark);
            background-color: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            .tool-card form div { flex-direction: column; align-items: flex-start; }
            .tool-card label { min-width: auto; margin-bottom: 0.5rem; }
             .tool-card input[type="file"], .tool-card input[type="number"],
             .tool-card select, .tool-card input[type="color"] { max-width: 100%; }
            .tool-card small { margin-left: 0; }
            .color-picker-container { flex-direction: row; align-items: center; width: 100%;}
            .color-picker-container label { margin-bottom: 0;}

            /* è™šæ‹Ÿèº«ä»½å“åº”å¼æ ·å¼ */
            .fake-id-grid {
                grid-template-columns: 100px 1fr;
            }
            .fake-id-grid strong {
                text-align: left;
            }
        }
    </style>

    <script>
        // Helper functions displayError, displayResult (ä¿æŒä¸å˜)
        function displayError(element, message) { element.innerHTML = `<p style="color: #dc2626; text-align: center;">âŒ é”™è¯¯: ${message}</p>`; }
        function displayResult(element, htmlContent) { element.innerHTML = htmlContent; }

        // --- å›¾ç‰‡å¤§å°è°ƒæ•´é€»è¾‘ (ä¿æŒä¸å˜) ---
        const resizeForm = document.getElementById('resize-form');
        const resizeResult = document.getElementById('resize-result');
        const resizeLoading = document.getElementById('resize-loading');
        const resizeImageInput = document.getElementById('resize-image');
        const resizeTargetInput = document.getElementById('target-size');
        const outputFormatSelect = document.getElementById('output-format');

        resizeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!resizeImageInput.files || resizeImageInput.files.length === 0) { displayError(resizeResult, "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚"); return; }
             if (!resizeTargetInput.value || parseInt(resizeTargetInput.value) <= 0) { displayError(resizeResult, "è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®æ ‡å¤§å° (KB)ã€‚"); return; }

            resizeLoading.style.display = 'flex';
            resizeResult.innerHTML = '';
            const formData = new FormData();
            formData.append('image', resizeImageInput.files[0]);
            const targetSizeKb = resizeTargetInput.value;
            const outputFormat = outputFormatSelect.value;
            const url = `/tools/resize-image?target_size_kb=${encodeURIComponent(targetSizeKb)}&output_format=${encodeURIComponent(outputFormat)}`;

            try {
                 const response = await fetch(url, { method: 'POST', body: formData });
                 if (!response.ok) { const errorText = await response.text(); throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status}: ${errorText || 'æœªçŸ¥é”™è¯¯'}`); }
                 const blob = await response.blob();
                 const imageUrl = URL.createObjectURL(blob);
                 const originalFileName = resizeImageInput.files[0].name;
                 let outputExtension = 'bin';
                 if (blob.type === 'image/png') outputExtension = 'png';
                 else if (blob.type === 'image/jpeg') outputExtension = 'jpg';
                 const baseFileName = originalFileName.includes('.') ? originalFileName.substring(0, originalFileName.lastIndexOf('.')) : originalFileName;
                 const newFileName = `${baseFileName}_${targetSizeKb}kb.${outputExtension}`;
                 const fileSizeKB = (blob.size / 1024).toFixed(2);
                 const resultHtml = ` <p>âœ… å¤„ç†æˆåŠŸ (ç›®æ ‡ ${targetSizeKb} KB):</p> <img src="${imageUrl}" alt="å¤„ç†åçš„å›¾ç‰‡"> <p class="info">å®é™…æ–‡ä»¶å¤§å°: ${fileSizeKB} KB</p> <p class="info">è¾“å‡ºæ ¼å¼: ${outputExtension.toUpperCase()}</p> <a href="${imageUrl}" download="${newFileName}" class="btn btn-secondary">ä¸‹è½½å›¾ç‰‡</a> `;
                 displayResult(resizeResult, resultHtml);
            } catch (error) {
                 console.error("å›¾ç‰‡è°ƒæ•´å‡ºé”™:", error);
                 displayError(resizeResult, error.message || "è°ƒæ•´è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚");
            } finally {
                resizeLoading.style.display = 'none';
            }
        });

        // --- èƒŒæ™¯æ›´æ¢é€»è¾‘ (remove.bg ç‰ˆæœ¬) ---
        const bgChangeForm = document.getElementById('bg-change-form');
        const bgChangeResult = document.getElementById('bg-change-result');
        const bgChangeLoading = document.getElementById('bg-change-loading');
        const bgImageInput = document.getElementById('bg-image');
        const targetColorInput = document.getElementById('target-color');

        bgChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!bgImageInput.files || bgImageInput.files.length === 0) { displayError(bgChangeResult, "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯ä»¶ç…§æ–‡ä»¶ã€‚"); return; }

            bgChangeLoading.style.display = 'flex';
            bgChangeResult.innerHTML = '';
            const formData = new FormData();
            formData.append('image', bgImageInput.files[0]);

            const targetColor = targetColorInput.value;
            const url = `/tools/change-background?target_color=${encodeURIComponent(targetColor)}`;

            try {
                 const response = await fetch(url, { method: 'POST', body: formData });
                 if (!response.ok) { const errorText = await response.text(); throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status}: ${errorText || 'æœªçŸ¥é”™è¯¯'}`); }
                 const result = await response.json();
                 if (result.success && result.imageData) {
                     const originalFileName = bgImageInput.files[0].name;
                     const baseFileName = originalFileName.includes('.') ? originalFileName.substring(0, originalFileName.lastIndexOf('.')) : originalFileName;
                     let outputExtension = 'png';
                     const mimeMatch = result.imageData.match(/^data:(image\/(\w+));base64,/);
                     if(mimeMatch && mimeMatch[2]) { outputExtension = mimeMatch[2] === 'jpeg' ? 'jpg' : mimeMatch[2]; }
                     const newFileName = `${baseFileName}_bg_changed.${outputExtension}`;
                     const resultHtml = ` <p>âœ… èƒŒæ™¯æ›´æ¢æˆåŠŸ:</p> <img src="${result.imageData}" alt="èƒŒæ™¯æ›´æ¢åçš„å›¾ç‰‡"> <a href="${result.imageData}" download="${newFileName}" class="btn btn-secondary">ä¸‹è½½å›¾ç‰‡</a> `;
                    displayResult(bgChangeResult, resultHtml);
                } else { throw new Error(result.message || 'åç«¯å¤„ç†å¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆå›¾ç‰‡æ•°æ®ã€‚'); }
            } catch (error) {
                 console.error("èƒŒæ™¯æ›´æ¢å‡ºé”™:", error);
                 displayError(bgChangeResult, error.message || 'èƒŒæ™¯æ›´æ¢è¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚');
            } finally {
                bgChangeLoading.style.display = 'none';
            }
        });

        // --- IP æŸ¥è¯¢é€»è¾‘ (ä¿æŒä¸å˜) ---
        const getIpBtn = document.getElementById('get-ip-btn');
        const ipResult = document.getElementById('ip-result');
        const ipLoading = document.getElementById('ip-loading');

        getIpBtn.addEventListener('click', async () => {
             ipLoading.style.display = 'flex';
             ipResult.innerHTML = '';
            try {
                 const response = await fetch('/api/tools/my-ip');
                 if (!response.ok) { throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status} ${response.statusText || ''}`); }
                 const data = await response.json();
                 if (data.ip) { displayResult(ipResult, `<p>ğŸŒ ä½ çš„ IP åœ°å€æ˜¯: <strong>${data.ip}</strong></p>`); }
                 else { throw new Error("æœªèƒ½ä»æœåŠ¡å™¨è·å– IP åœ°å€ã€‚"); }
            } catch (error) {
                 console.error("IP æŸ¥è¯¢å‡ºé”™:", error);
                 displayError(ipResult, error.message || 'æŸ¥è¯¢ IP åœ°å€æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚');
            } finally {
                ipLoading.style.display = 'none';
            }
        });

         // --- ä¿ç•™ target-color çš„äº‹ä»¶ç›‘å¬ ---
         document.getElementById('target-color').addEventListener('input', (e) => {
             const select = e.target.nextElementSibling;
             if (select && select.tagName === 'SELECT') {
                 select.style.backgroundColor = e.target.value;
             }
         });

         // Initialize select backgrounds on load (åªåˆå§‹åŒ– target-color çš„)
         document.querySelectorAll('select[onchange*="backgroundColor"]').forEach(select => {
            if (select.previousElementSibling && select.previousElementSibling.id === 'target-color') {
                 select.style.backgroundColor = select.value;
            }
         });


        // --- ç¾å›½è™šæ‹Ÿèº«ä»½ç”Ÿæˆå™¨é€»è¾‘ ---
        const fakeIdForm = document.getElementById('fake-id-form');
        const fakeIdResult = document.getElementById('fake-id-result');
        const fakeIdLoading = document.getElementById('fake-id-loading');
        // *** ä¿®æ”¹ç‚¹: ç§»é™¤ locale select çš„å¼•ç”¨ ***
        // const fakeIdLocaleSelect = document.getElementById('fake-id-locale');

        fakeIdForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            fakeIdLoading.style.display = 'flex';
            fakeIdResult.innerHTML = '';

            // *** ä¿®æ”¹ç‚¹: ä¸å†è¯»å– localeï¼ŒURL ä¸å¸¦å‚æ•° ***
            // const selectedLocale = fakeIdLocaleSelect.value;
            // const url = `/api/tools/fake-identity?locale=${encodeURIComponent(selectedLocale)}`;
            const url = `/api/tools/fake-identity`; // ç›´æ¥è°ƒç”¨ï¼Œåç«¯ä¼šç”Ÿæˆ en_US

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯ ${response.status}: ${errorText || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const data = await response.json();

                // æ„å»ºè¦æ˜¾ç¤ºçš„ HTML (åœ°åŒºç°åœ¨å›ºå®šä¸º en_US)
                const resultHtml = `
                    <p>âœ… ç”ŸæˆæˆåŠŸ (åœ°åŒº: ${data.locale}):</p>
                    <div class="fake-id-grid">
                        <strong>å§“å:</strong> <span>${data.name}</span>
                        <strong>ç”¨æˆ·å:</strong> <span>${data.username}</span>
                        <strong>é‚®ç®±:</strong> <span>${data.email}</span>
                        <strong>ç”µè¯:</strong> <span>${data.phone}</span>
                        <strong>å…¬å¸:</strong> <span>${data.company}</span>
                        <strong>åœ°å€:</strong> <span>${data.address}</span>
                    </div>
                `;
                displayResult(fakeIdResult, resultHtml);

            } catch (error) {
                console.error("è™šæ‹Ÿèº«ä»½ç”Ÿæˆå‡ºé”™:", error);
                displayError(fakeIdResult, error.message || "ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚");
            } finally {
                fakeIdLoading.style.display = 'none';
            }
        });


        // --- spin åŠ¨ç”» keyframes æ³¨å…¥ (ä¿æŒä¸å˜) ---
        const styleSheet = document.styleSheets[0]; let spinKeyframesFound = false; if (styleSheet) { try { for (const rule of styleSheet.cssRules) { if (rule.type === CSSRule.KEYFRAMES_RULE && rule.name === 'spin') { spinKeyframesFound = true; break; } } } catch (e) { console.warn("Could not check for existing 'spin' keyframes:", e); } } if (!spinKeyframesFound) { const keyframes = ` @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`; if (styleSheet) { try { styleSheet.insertRule(keyframes, styleSheet.cssRules.length); } catch (e) { console.error("Failed to insert spin keyframes:", e) } } else { const styleTag = document.createElement('style'); styleTag.textContent = keyframes; document.head.appendChild(styleTag); } }

    </script>

{% endblock %}