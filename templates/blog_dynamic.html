{% extends "base.html" %}

{% block title %}æŠ€æœ¯åšå®¢{% endblock %}

{% block content %}
    <h1>æŠ€æœ¯åšå®¢ ğŸ“</h1>
    <p>è®°å½•æˆ‘åœ¨æŠ€æœ¯æ¢ç´¢è·¯ä¸Šçš„æ€è€ƒã€å®è·µå’Œæ€»ç»“ã€‚æ¶µç›–Webå¼€å‘ã€ç³»ç»Ÿè®¾è®¡ã€ç¼–ç¨‹è¯­è¨€ç­‰å¤šä¸ªé¢†åŸŸçš„æ·±åº¦æ–‡ç« ã€‚</p>

    <!-- åšå®¢ç»Ÿè®¡åŒºåŸŸ -->
    <div class="blog-stats-section">
        <h2>ğŸ“Š åšå®¢ç»Ÿè®¡</h2>
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“„</div>
                    <div class="stat-content">
                        <span class="stat-number">{{ total_articles }}</span>
                        <span class="stat-label">æŠ€æœ¯æ–‡ç« </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ·ï¸</div>
                    <div class="stat-content">
                        <span class="stat-number">{{ categories.len() }}</span>
                        <span class="stat-label">æ–‡ç« åˆ†ç±»</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â­</div>
                    <div class="stat-content">
                        <span class="stat-number">2</span>
                        <span class="stat-label">ç²¾é€‰æ–‡ç« </span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â±ï¸</div>
                    <div class="stat-content">
                        <span class="stat-number">19</span>
                        <span class="stat-label">æ€»é˜…è¯»æ—¶é•¿(åˆ†é’Ÿ)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰æ§åˆ¶ -->
    <div class="blog-controls">
        <div class="search-container">
            <input type="text" id="article-search" placeholder="ğŸ” æœç´¢æ–‡ç« ..." class="search-input">
        </div>
        <div class="filter-container">
            <select id="category-filter" class="filter-select">
                <option value="all">æ‰€æœ‰åˆ†ç±»</option>
                {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
            <select id="sort-filter" class="filter-select">
                <option value="date-desc">æœ€æ–°å‘å¸ƒ</option>
                <option value="date-asc">æœ€æ—©å‘å¸ƒ</option>
                <option value="read-time-asc">é˜…è¯»æ—¶é•¿(çŸ­)</option>
                <option value="read-time-desc">é˜…è¯»æ—¶é•¿(é•¿)</option>
                <option value="title">æ ‡é¢˜æ’åº</option>
            </select>
            <button id="featured-only" class="btn btn-small btn-secondary">ä»…æ˜¾ç¤ºç²¾é€‰</button>
            <button id="clear-filters" class="btn btn-small btn-secondary">æ¸…é™¤ç­›é€‰</button>
        </div>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <div id="articles-container" class="articles-grid">
        {% if articles.is_empty() %}
            <div class="no-articles">
                <p>ğŸ“ æš‚æ— æ–‡ç« </p>
                <p>æ›´å¤šç²¾å½©å†…å®¹æ­£åœ¨å‡†å¤‡ä¸­...</p>
            </div>
        {% else %}
            {% for article in articles %}
                <article class="article-card"
                         data-category="{{ article.category }}"
                         data-read-time="{{ article.read_time }}"
                         data-date="{{ article.publish_date }}"
                         data-title="{{ article.title }}"
                         data-featured="{{ article.featured }}">
                    
                    <div class="article-header">
                        {% if article.featured %}
                            <span class="featured-badge">â­ ç²¾é€‰</span>
                        {% endif %}
                        <span class="category-badge" data-category="{{ article.category }}">
                            {{ article.category }}
                        </span>
                    </div>

                    <h3 class="article-title">
                        <a href="/blog/{{ article.id }}" class="article-link">
                            {{ article.title }}
                        </a>
                    </h3>

                    <p class="article-excerpt">{{ article.excerpt }}</p>

                    <div class="article-tags">
                        {% for tag in article.tags %}
                            <span class="tag">#{{ tag }}</span>
                        {% endfor %}
                    </div>

                    <div class="article-meta">
                        <span class="publish-date">ğŸ“… {{ article.publish_date }}</span>
                        <span class="read-time">â±ï¸ {{ article.read_time }} åˆ†é’Ÿé˜…è¯»</span>
                    </div>

                    <div class="article-actions">
                        <a href="/blog/{{ article.id }}" class="btn btn-primary btn-small">
                            é˜…è¯»å…¨æ–‡
                        </a>
                        <button class="btn btn-secondary btn-small share-btn" 
                                data-title="{{ article.title }}"
                                data-url="/blog/{{ article.id }}">
                            åˆ†äº«
                        </button>
                    </div>
                </article>
            {% endfor %}
        {% endif %}
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨åŠ è½½æ–‡ç« ...</p>
    </div>

    <script>
        // åšå®¢æ–‡ç« ç®¡ç†å™¨
        class BlogManager {
            constructor() {
                this.articles = Array.from(document.querySelectorAll('.article-card'));
                this.searchInput = document.getElementById('article-search');
                this.categoryFilter = document.getElementById('category-filter');
                this.sortFilter = document.getElementById('sort-filter');
                this.featuredOnlyBtn = document.getElementById('featured-only');
                this.clearFiltersBtn = document.getElementById('clear-filters');
                this.showFeaturedOnly = false;
                
                this.init();
            }

            init() {
                this.searchInput?.addEventListener('input', () => this.filterArticles());
                this.categoryFilter?.addEventListener('change', () => this.filterArticles());
                this.sortFilter?.addEventListener('change', () => this.sortArticles());
                this.featuredOnlyBtn?.addEventListener('click', () => this.toggleFeaturedOnly());
                this.clearFiltersBtn?.addEventListener('click', () => this.clearAllFilters());
                
                // åˆå§‹æ’åº
                this.sortArticles();
                
                // åˆ†äº«æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.shareArticle(e));
                });
            }

            filterArticles() {
                const searchTerm = this.searchInput.value.toLowerCase();
                const selectedCategory = this.categoryFilter.value;
                
                this.articles.forEach(article => {
                    const title = article.querySelector('.article-title').textContent.toLowerCase();
                    const excerpt = article.querySelector('.article-excerpt').textContent.toLowerCase();
                    const category = article.dataset.category;
                    const featured = article.dataset.featured === 'true';
                    
                    const matchesSearch = title.includes(searchTerm) || excerpt.includes(searchTerm);
                    const matchesCategory = selectedCategory === 'all' || category === selectedCategory;
                    const matchesFeatured = !this.showFeaturedOnly || featured;
                    
                    if (matchesSearch && matchesCategory && matchesFeatured) {
                        article.style.display = 'block';
                        article.style.animation = 'fadeIn 0.3s ease-in';
                    } else {
                        article.style.display = 'none';
                    }
                });
            }

            sortArticles() {
                const sortBy = this.sortFilter.value;
                const container = document.getElementById('articles-container');
                
                const sorted = [...this.articles].sort((a, b) => {
                    switch (sortBy) {
                        case 'date-asc':
                            return new Date(a.dataset.date) - new Date(b.dataset.date);
                        case 'date-desc':
                            return new Date(b.dataset.date) - new Date(a.dataset.date);
                        case 'read-time-asc':
                            return parseInt(a.dataset.readTime) - parseInt(b.dataset.readTime);
                        case 'read-time-desc':
                            return parseInt(b.dataset.readTime) - parseInt(a.dataset.readTime);
                        case 'title':
                            return a.dataset.title.localeCompare(b.dataset.title);
                        default:
                            return new Date(b.dataset.date) - new Date(a.dataset.date);
                    }
                });
                
                // é‡æ–°æ’åˆ—DOMå…ƒç´ 
                sorted.forEach(article => container.appendChild(article));
            }

            toggleFeaturedOnly() {
                this.showFeaturedOnly = !this.showFeaturedOnly;
                this.featuredOnlyBtn.textContent = this.showFeaturedOnly ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'ä»…æ˜¾ç¤ºç²¾é€‰';
                this.featuredOnlyBtn.classList.toggle('active', this.showFeaturedOnly);
                this.filterArticles();
            }

            clearAllFilters() {
                this.searchInput.value = '';
                this.categoryFilter.value = 'all';
                this.sortFilter.value = 'date-desc';
                this.showFeaturedOnly = false;
                this.featuredOnlyBtn.textContent = 'ä»…æ˜¾ç¤ºç²¾é€‰';
                this.featuredOnlyBtn.classList.remove('active');
                this.filterArticles();
                this.sortArticles();
            }

            shareArticle(event) {
                const btn = event.target;
                const title = btn.dataset.title;
                const url = window.location.origin + btn.dataset.url;
                
                if (navigator.share) {
                    navigator.share({
                        title: title,
                        url: url
                    });
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(url).then(() => {
                        btn.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => {
                            btn.textContent = 'åˆ†äº«';
                        }, 2000);
                    });
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new BlogManager();
            
            // æ·»åŠ è¿›å…¥åŠ¨ç”»
            const cards = document.querySelectorAll('.article-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>

    <style>
        /* æ–‡ç« å¡ç‰‡åˆå§‹çŠ¶æ€ï¼ˆç”¨äºåŠ¨ç”»ï¼‰ */
        .article-card {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .no-articles {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }

        .featured-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b5a00;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .article-link {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .article-link:hover {
            color: var(--primary-color);
        }
    </style>
{% endblock %}